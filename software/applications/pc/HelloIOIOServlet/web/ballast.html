<!DOCTYPE HTML>
<html>
<head>
	<title>pixi.js example 8 Dragging</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #FFFFFF;
			
		}
		
		.textHolder{
			width: 400px;
		}
	</style>
	<script src="/js/pixi.js"></script>
</head>
<body>
	<script>
	
	// create an new instance of a pixi stage
	var stage = new PIXI.Stage(0x97c56e, true);
	// create a renderer instance
	var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, {antialias: true});
	
	// add the renderer view element to the DOM
	document.body.appendChild(renderer.view);
	renderer.view.style.position = "absolute";
	renderer.view.style.top = "0px";
	renderer.view.style.left = "0px";
	requestAnimFrame( animate );
	
	// create a texture from an image path
	var texture = PIXI.Texture.fromImage("/images/Ballast.png");
	var background = new PIXI.Sprite(texture);
	background.position.x = 0;
	background.position.y = 0;
	background.width = window.innerWidth;
	background.height = window.innerHeight;
	stage.addChild(background);
	
	//for (var i=0; i < 10; i++) 
	//{
	//	createValve(Math.random(), Math.random(), 30, 18, Math.random(), Math.PI / 2)
	//};
	createValve(0.1, 0.1, 30, 18, Math.random(), Math.PI / 2);
	createValve(0.1, 0.2, 30, 18, Math.random(), 0);
	
	var countingText = new PIXI.Text("3.2", { font: " 20px Arial", fill: "#3e1707", align: "center" });
	countingText.position.x = window.innerWidth * 0.49;
	countingText.position.y = window.innerHeight * 0.41;
	makeEditable(countingText);
	stage.addChild(countingText);
	
	
	function createValve(x, y, width, height, position, rotation)
	{
		var valve = new PIXI.Graphics();
		
		makeEditable(valve);
		
		valve.lineStyle(2, 0x000000);
		if(position > 0.5)
			valve.beginFill(0x00FF00);
		else
			valve.beginFill(0x000000);
		valve.moveTo(0, 0);
		valve.lineTo(0 - width / 2, 0 - height / 2);
		valve.lineTo(0, 0 - height);
		valve.lineTo(0, 0);
		valve.endFill();
		
		if(position > 0.5)
			valve.beginFill(0x00FF00);
		else
			valve.beginFill(0x000000);
		valve.moveTo(0 - width, 0 - height);
		valve.lineTo(0 - width / 2, 0 - height / 2);
		valve.lineTo(0 - width, 0);
		valve.lineTo(0 - width, 0 - height);
		valve.endFill();
		
		valve.position.x = x * window.innerWidth;
		valve.position.y = y * window.innerHeight;
		valve.rotation = rotation;
		
		// add it to the stage
		stage.addChild(valve);
	}
	
	function makeEditable(valve)
	{
	
		// enable the valve to be interactive.. this will allow it to respond to mouse and touch events		
		valve.interactive = true;
		// this button mode will mean the hand cursor appears when you rollover the valve with your mouse
		valve.buttonMode = true;
		//valve.anchor.x = 0.5;
		//valve.anchor.y = 0.5;
		
		// use the mousedown and touchstart
		valve.mousedown = valve.touchstart = function(data)
		{
	//		data.originalEvent.preventDefault()
			// store a refference to the data
			// The reason for this is because of multitouch
			// we want to track the movement of this particular touch
			this.data = data;
			//this.alpha = 0.9;
			this.dragging = true;
			this.moved = false;
		};
		
		// set the events for when the mouse is released or a touch is released
		valve.mouseup = valve.mouseupoutside = valve.touchend = valve.touchendoutside = function(data)
		{
			//this.alpha = 1
			this.dragging = false;
			// set the interaction data to null
			this.data = null;
			if(this.moved == false) {
				//If we haven't moved, then this was a simple click.
				var valvePosition = prompt("DesiredValvePosition", "0.0");
    			if (valvePosition != null) {
					window.location = "/sim/core?name=V1&value=" + valvePosition;
				}
			}
		};
		
		// set the callbacks for when the mouse or a touch moves
		valve.mousemove = valve.touchmove = function(data)
		{
			if(this.dragging)
			{
				// need to get parent coords..
				var newPosition = this.data.getLocalPosition(this.parent);
				this.position.x = newPosition.x;
				this.position.y = newPosition.y;
				this.moved = true;
			}
		}
	}
	
	function animate() {
	
	    requestAnimFrame( animate );
	
	    // just for fun, lets rotate mr rabbit a little
		//stage.interactionManager.update();
	    // render the stage   
	    renderer.render(stage);
	}

	</script>

	</body>
</html>
